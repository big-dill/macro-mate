/*
 * Script for tag autocomplete
 */

// #id_tags is generated by django's form automatically
const tagElement = document.querySelector("#id_tags");

// create 'Tagify' object from tagify library.
const tagify = new Tagify(tagElement, {
  placeholder: "add tags",
  dropdown: {
    highlightFirst: true,
  },
  whitelist: [],
});

// listen to any keystrokes, execute callback below
tagify.on("input", onInput);

// create a dummy request object, so that we can abort AJAX requests
let request;

// callback
function onInput(e) {
  // reset the whitelist
  tagify.settings.whitelist.length = 0;
  // show loading animation and hide the suggestions dropdown
  tagify.loading(true).dropdown.hide.call(tagify);
  // get search_string from input
  const value = e.detail.value;
  // abort any previous requests
  if (request) {
    request.abort();
  }

  // AJAX get request
  // url will be macro_mate's TAGS API
  // stored in request object to abort if further input
  request = $.get({
    url: "api/tags",
    data: {
      contains: value, // Use the value taken from the input
      max_results: 10,
    },
    dataType: "json",
  }).done(function(taglist) {
    // update inwhitelist Array in-place
    tagify.settings.whitelist.splice(0, taglist.length, ...taglist);
    // render the suggestions dropdown
    tagify.loading(false).dropdown.show.call(tagify, value);
  });
}
