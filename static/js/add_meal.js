/**
 * addTagify
 *
 * A wrapper which can be used in the view template so that the URL for the API call can
 * be set by django. The rest is a script for setting up the tags.
 *
 * @param {string} url
 * @param {number=} maxResults
 */
function addTagify(url, maxResults) {
  // #id_tags is generated by django's form automatically
  const $tagInput = $("#id_tags");
  const tagInputElement = $tagInput.get()[0];
  // create 'Tagify' object from tagify library. Whitelist in the tag list
  const tagify = new Tagify(tagInputElement, {
    placeholder: "add tags",
    dropdown: {
      highlightFirst: true,
    },
    whitelist: [],
    enforceWhitelist: false,
  });
  // listen to any keystrokes, execute callback below
  tagify.on("input", onInput);

  let request;

  tagify.on("add", () => tagify.input.set.call(tagify));
  tagify.on("remove", () => tagify.input.set.call(tagify));

  // callback
  function onInput(e) {
    // reset the whitelist
    tagify.settings.whitelist.length = 0;
    // show loading animation and hide the suggestions dropdown
    tagify.loading(true).dropdown.hide.call(tagify);
    // get search_string from input
    const value = e.detail.value;
    // abort any previous requests
    if (request) {
      request.abort();
    }

    // AJAX get request (shorthand for AJAX)
    // url will be macro_mate's TAGS API
    request = $.get({
      url: url,
      data: {
        contains: value, // Use the value taken from the input
        max_results: 10,
      },
      dataType: "json",
    }).done(function(whitelist) {
      // update inwhitelist Array in-place
      tagify.settings.whitelist.splice(0, whitelist.length, ...whitelist);
      // render the suggestions dropdown
      tagify.loading(false).dropdown.show.call(tagify, value);
    });
  }
}
